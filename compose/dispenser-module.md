# Dispenser Documentation

## Overview
This module is designed to:
- Collect data from the Ultrasonic Sensor to provide the distance that represents the amount remaining and amount used on each container.
- Store and collect data in both remote (MongoDB) and local (JSON File) database
- Operate as a streamlined backend service withou a complex GUI

## Harware Configuration
- Each ultrasonic sensor denoted as SONIC are place each respectively on each container: CONT1, CONT2, CONT3, and CONT4
- The ultrasonic will detect the distance that represent how much remaining from each container

At the first run of the script the script will utilize all of the ultrasonic sensor to check the initial volume on each container.

The remote database is the main priority when it is offline or down, then use the local.
The remote database will reflect exactly to the local database
The remote collection name is `dispenser_resource` and the database name is `Smart_Cubicle`
The formatting of the data if from the `dispenser-data.json`, stritly follow the format. The default directory is `/home/admin/Documents/local-data` if the `local-data` directory is not exist then create one to store the `disp-data.json` file. If the file does not exist, create it.

Also the script will check if there are previous `reading` from the remote first before the local, so that it will resume the last update reading.

Database format
```
{
    "_id": "ObjectId()",
    "reading": 0,
    "timestamp": "YYYY-MM-DD HH:MM:SS",
    "data": {
        "CONT1": {
            "distance_cm": 0.0,
            "remaining_volume_ml": 0.0
        },
        "CONT2": {
            "distance_cm": 0.0,
            "remaining_volume_ml": 0.0
        },
        "CONT3": {
            "distance_cm": 0.0,
            "remaining_volume_ml": 0.0
        },
        "CONT4": {
            "distance_cm": 0.0,
            "remaining_volume_ml": 0.0
        }
    }
}
```
where the:
"_id": - is autogenerated ID from the mongoDB but make sure it is the same with the local database
"reading": - this is the counter for eadings, make sure to scan first the database: remote first before local if there are previous so that it can resume from the counter number
"timestamp": - this is when the reading was taken follow the formatting `YYYY-MM-DD HH:MM:SS`
"data": - this contains the reading from the 4 containers (CONT1-4)
"distance_cm": - is the distance measured by the ultrasonic sensor in centimeters
"previous_volume_ml": - lat recorded volume in milimeters
"remaining_volume_ml:" Current volume remaining in milimeters


Now this will be the expected dislay in the CLI
```
Checking the connection to Database...
Database Connected Succesfully!
Detecting the initial volume for each container...
CONT1: [distance cm] [volume ml] [precentage %] | CONT2: [distance cm] [volume ml] [precentage %] | CONT3: [distance cm] [volume ml] [precentage %] | CONT4: [distance cm] [volume ml] [precentage %]
The sensors are ready!
```

Each of the measurements have a 2 significant figures (2 decimal points)

How the data will be saved to the Database basically instead of continously logging and saving to the database there is a certain condition only.
This is to avoid flooding the database: Remote and Local instead there is a certain condition.

The program will scan continously like this
```
[2025-04-29 08:59:10] CONT1: [distance cm] [volume ml] [precentage %] | CONT2: [distance cm] [volume ml] [precentage %] | CONT3: [distance cm] [volume ml] [precentage %] | CONT4: [distance cm] [volume ml] [precentage %]
```
the logging in every 5 seconds delay, this is continously check if there is a changes on each containter but no saving to the database: remote and local

if there is a significant change on the reading like from the whole number not on the decimal therefore it will save to the database: remote and local
Note whole number not the decimal is the reference point of saving a data to the remote, if there is a significant change in the reading from the whole number then saved to both remote and local database, if decimal only do not. Because sensors have some tolerance error.
For example
```
[2025-05-02 13:58:49] CONT1: 10.97 cm 73.50 ml 10% | CONT2: 8.83 cm 145.99 ml 20% | CONT3: 3.96 cm 352.20 ml 30% | CONT4: 7.42 cm 232.75 ml 40%
```
then the 5 second delay again
```
[2025-05-02 13:59:54] CONT1: 10.97 cm 73.50 ml 10% | CONT2: 8.83 cm 145.99 ml 20% | CONT3: 3.96 cm 352.20 ml 30% | CONT4: 7.42 cm 232.75 ml 40%
```
observed that there is no changes happens, but what if somone dispense
```
[2025-05-02 14:01:25] CONT1: 10.97 cm 73.50 ml 10% | CONT2: 8.83 cm 145.99 ml 20% | CONT3: 3.96 cm 352.20 ml 30% | CONT4: 7.42 cm 232.75 ml 40%
```
note that the readings changes (this is a sample only make the logic in a realistic way as possible), therefore there somone dispense on the reading, therefore saved to the database: remote and local (note that remote is much priority from the local), but at least 1 of the container changes then still record to the database with a message
```
Status: DATA SAVED TO REMOTE AND LOCAL
```

The script program will terminate if the user press the CTRL + C, when about to terminate save immediately the last reading irregardless if there is a changes from the previous and current reading, saved it to the database: remote and local